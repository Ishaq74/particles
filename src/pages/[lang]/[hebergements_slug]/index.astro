---
export const prerender = true;

import Layout from '@layouts/Layout.astro';
import PageHeader from '@components/blog/PageHeader.astro';
import AccommodationCard from '@components/accommodation/AccommodationCard.astro';
import AccommodationCategoriesWithCount from '@components/accommodation/AccommodationCategoriesWithCount.astro';
import { loadPlaceCollections } from '@utils/placeContent';

export async function getStaticPaths() {
  // Routes hébergements explicites, pas de scaling
  const langs = ['fr', 'en', 'es'];
  return langs.map(lang => ({ params: { lang, hebergements_slug: 'hebergements' } }));
}

const { lang, hebergements_slug } = Astro.params;
const pageContext = Astro.locals.pageContext;
if (!pageContext || pageContext.type !== 'hebergements') {
  throw new Error('Contexte hébergements absent ou incorrect');
}
const categoryId = pageContext.entityId;
const entityConfig = pageContext.entityConfig;
const { rootCategory, featured, recent } = await loadPlaceCollections(entityConfig, lang);

const pageTitle = rootCategory?.name ?? 'Hébergements';
const categoryDescription = rootCategory?.description ?? null;
const hebergementsSlugResolved = pageContext.slug ?? rootCategory?.slug ?? hebergements_slug ?? 'hebergements';
const featuredAccommodations = featured.map((item) => item.accommodation);
const recentAccommodations = recent.map((item) => item.accommodation);
const hasContext = Boolean(pageContext?.entityId);
---

<Layout title={pageTitle} lang={lang}>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {hasContext ? (
      <>
        <PageHeader
          title={pageTitle}
          description={categoryDescription || "Découvrez nos hébergements à Annecy et ses environs."}
          lang={lang}
          magazineSlug={hebergementsSlugResolved}
          breadcrumbItems={[ 
            { label: lang === 'fr' ? 'Accueil' : 'Home', url: `/${lang}/`, icon: 'openmoji:house' },
            { label: pageTitle, icon: 'openmoji:bed', isCurrent: true },
          ]}
        />
        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-12">
          <div class="lg:col-span-2">
            <section class="mb-12">
              <h2 class="text-3xl font-bold text-gray-800 mb-6">À la une</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                {featuredAccommodations.length > 0 ? (
                  featuredAccommodations.map(place => (
                    <AccommodationCard
                      accommodation={place}
                      lang={lang}
                      hebergementsSlug={hebergementsSlugResolved}
                      variantData="full"
                      variantStyle="featured"
                    />
                  ))
                ) : (
                  <p class="text-gray-500 col-span-2">Aucun hébergement en vedette pour le moment.</p>
                )}
              </div>
            </section>
            <section>
              <h2 class="text-3xl font-bold text-gray-800 mb-6">Hébergements récents</h2>
              <div class="space-y-6">
                {recentAccommodations.length > 0 ? (
                  recentAccommodations.map(place => (
                    <AccommodationCard
                      accommodation={place}
                      lang={lang}
                      hebergementsSlug={hebergementsSlugResolved}
                      variantData="recent"
                      variantStyle="horizontal"
                    />
                  ))
                ) : (
                  <p class="text-gray-500">Aucun hébergement récent pour le moment.</p>
                )}
              </div>
            </section>
          </div>
          <div class="mt-12 lg:mt-0">
            <aside class="space-y-8 sticky top-8">
              <AccommodationCategoriesWithCount parentId={categoryId} hebergementsSlug={hebergementsSlugResolved} />
            </aside>
          </div>
        </div>
      </>
    ) : (
      <div class="py-16 text-center text-gray-500">
        <h1 class="text-2xl font-bold mb-4">Aucune catégorie d'hébergements sélectionnée</h1>
        <p>Impossible d’afficher cette page car le contexte de catégorie est absent ou incorrect.</p>
      </div>
    )}
  </main>
</Layout>