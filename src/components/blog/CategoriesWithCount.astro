---
import { Card, CardHeader, CardContent, CardTitle } from '@components/starwind/card';
import { Badge } from '@components/starwind/badge';
import { Icon } from 'astro-icon/components';
import { getCollection } from 'astro:content';
import { getCategoryDefaultSlug } from '@utils/contentLookup';


const rawLang = Astro.locals.lang;
const { parentId, magazineSlug: rawMagazineSlug } = Astro.props;
const lang = rawLang ?? 'fr';
const magazineSlug = rawMagazineSlug ?? 'magazine';

// Traductions frontmatter
const translations = {
  fr: {
    title: 'Catégories',
    empty: 'Aucune catégorie disponible.'
  },
  en: {
    title: 'Categories',
    empty: 'No category available.'
  },
  es: {
    title: 'Categorías',
    empty: 'Ninguna categoría disponible.'
  }
};
const t = translations[lang] ?? translations.fr;

// --- Récupération des catégories enfants (sous-catégories) avec nombre d’articles ---
// (reprend exactement ta logique du frontmatter de index.astro)
let categories: Array<{ id: string; name: string; seo_slug: string; articles_count: number; }> = [];

if (parentId) {
  const allCategories = await getCollection('categories');
  const allArticles = await getCollection('articles');
  const childCategories = allCategories.filter((cat: any) => cat.data.parentId === parentId);
  categories = childCategories.map((cat: any) => {
    const translation = cat.data.translations?.find((t: any) => t.langCode === lang) ?? cat.data.translations?.[0];
    // Count articles for this category
    const articles_count = allArticles.filter((article: any) => article.data.categoryId === cat.id).length;
    return {
      id: cat.id,
      name: translation?.name || cat.data.slug,
      seo_slug: translation?.seoSlug || getCategoryDefaultSlug(cat, lang) || cat.data.slug,
      articles_count,
    };
  });
}
---

<Card>
  <CardHeader>
    <CardTitle class="flex items-center gap-2">
      <Icon name="openmoji:bookmark-tabs" class="h-5 w-5" />
      {t.title}
    </CardTitle>
  </CardHeader>
  <CardContent>
    {categories.length > 0 ? (
      <ul class="space-y-2">
        {categories.map(cat => (
          <li>
            <a href={`/${lang}/${magazineSlug}/${cat.seo_slug || ''}`} class="flex justify-between items-center text-gray-600 hover:text-blue-600 font-medium p-2 -m-2 rounded-lg hover:bg-slate-50 transition-colors">
              <span>{cat.name}</span>
              <Badge variant="secondary">{cat.articles_count}</Badge>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <div class="flex flex-col items-center py-8">
        <Icon name="openmoji:desert" class="h-16 w-16 mx-auto text-gray-400 mb-4" />
        <span class="text-gray-500 text-sm">{t.empty}</span>
      </div>
    )}
  </CardContent>
</Card>